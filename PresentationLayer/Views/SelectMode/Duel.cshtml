<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Duel</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/css/duel-style.css" rel="stylesheet" />
</head>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="text-center">Quiz Duel</h1>
            <div id="questionSection" style="display: none;">
                <h2 id="questionText"></h2>
                <img id="questionImage" src="~/img/questions/" alt="Question Image" style="display: none;">
                <ul id="answersList" class="list-group"></ul>
                <button id="submitAnswerBtn" class="btn btn-primary" disabled>Submit Answer</button>
            </div>
            <button id="joinDuelBtn" class="btn btn-primary">Join Duel</button>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.11/signalr.min.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/gameHub")
        .build();

    let chatRoom = '';
    let selectedAnswer = '';

    connection.on("ReceiveMessage", function (userName, message) {
        console.log(`${userName}: ${message}`);
        alert(`${userName}: ${message}`);
    });

    connection.on("ReceiveQuestion", function (questionId, questionText, imageUrl, answers) {
        console.log("Received question:", questionText);
        document.getElementById('questionText').innerText = questionText;
        document.getElementById('questionText').setAttribute('data-question-id', questionId); // Set the question ID
        if (imageUrl) {
            document.getElementById('questionImage').src = imageUrl;
            document.getElementById('questionImage').style.display = 'block';
        } else {
            document.getElementById('questionImage').style.display = 'none';
        }
        const answersList = document.getElementById('answersList');
        answersList.innerHTML = ''; // Clear previous answers
        answers.forEach(answer => {
            const li = document.createElement('li');
            li.textContent = answer;
            li.classList.add('list-group-item');
            li.addEventListener('click', function () {
                selectedAnswer = answer;
                document.getElementById('submitAnswerBtn').disabled = false; // Enable submit button
            });
            answersList.appendChild(li);
        });
    });

    connection.on("GameReady", function () {
        console.log("Both players are ready!");
        document.getElementById('questionSection').style.display = 'block';
    });

    connection.on("StartGame", function () {
        console.log("Game has started!");
        document.getElementById('questionSection').style.display = 'block';
        getNextQuestion();
    });

    async function joinDuel() {
        try {
            await connection.start();
            const userName = prompt("Enter your username");
            chatRoom = prompt("Enter room name");
            await connection.invoke("JoinDuel", { UserName: userName, ChatRoom: chatRoom });
            console.log("Connected and joined duel");
        } catch (err) {
            console.error(err);
        }
    }

    async function getNextQuestion() {
        try {
            await connection.invoke("GetNextQuestion", chatRoom, 0); // Assuming starting with the first question
        } catch (err) {
            console.error(err);
        }
    }

    async function submitAnswer(questionId, answer) {
        try {
            await connection.invoke("AnswerQuestion", chatRoom, questionId, answer);
            document.getElementById('submitAnswerBtn').disabled = true; // Disable submit button after submission
            getNextQuestion(); // Fetch the next question after submitting the answer
        } catch (err) {
            console.error("Error invoking AnswerQuestion:", err);
        }
    }

    document.getElementById('joinDuelBtn').addEventListener('click', joinDuel);
    document.getElementById('submitAnswerBtn').addEventListener('click', function() {
        if (selectedAnswer) {
            const questionId = document.getElementById('questionText').getAttribute('data-question-id');
            submitAnswer(questionId, selectedAnswer);
        }
    });

</script>
</body>
</html>
